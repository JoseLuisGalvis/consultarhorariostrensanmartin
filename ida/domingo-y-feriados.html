<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Favicon -->
    <link rel="icon" href="../assets/images/icono.png" type="image/png" />
    <title>Ida: Domingos y Feriados - Tren San Mart铆n</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- FontAwesome CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- AOS CSS para animaciones -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div class="container-fluid d-flex flex-column min-vh-100 text-white">
      <!--  Navbar  -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary p-2">
        <div class="container-fluid">
          <h3>
            <i class="fas fa-train me-2 mx-2"></i>
            <a
              href="https://www.trensanmartin.com.ar/"
              target="_blank"
              class="train-title"
              >Tren San Mart铆n</a
            >
          </h3>

          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mx-2">
              <li class="nav-item">
                <a class="nav-link" href="../index.html">Inicio</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="../html/clima.html">Clima</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="../html/map.html">Mapa</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="../html/contact.html">Contacto</a>
              </li>
            </ul>
            <span class="current-time">Hora: --:--:--</span>
            <div class="d-flex align-items-center">
              <!-- Bot贸n de Internacionalizaci贸n -->
              <div class="dropdown mx-2">
                <ul class="dropdown-menu">
                  <li>
                    <button class="dropdown-item" data-lang="es">
                       Espa帽ol
                    </button>
                  </li>
                  <li>
                    <button class="dropdown-item" data-lang="en">
                      吼 English
                    </button>
                  </li>
                </ul>
                <button
                  class="btn btn-outline-language dropdown-toggle"
                  id="languageDropdown"
                  data-bs-toggle="dropdown"
                >
                  Espa帽ol
                </button>
              </div>
              <!-- Bot贸n de Modo Oscuro/Claro -->
              <button class="btn btn-light me-2 toggle-dark-mode">
                <i class="fas fa-moon moon-icon"></i>
                <i class="fas fa-sun sun-icon d-none"></i>
              </button>
              <div>
                <a
                  href="../html/schedule.html"
                  class="btn btn-outline-light btn-atras"
                  aria-label="Volver al cronograma"
                  >Atr谩s</a
                >
              </div>
            </div>
          </div>
        </div>
      </nav>
      <!-- Main -->
      <main
        class="flex-grow-1 d-flex flex-column align-items-center justify-content-center text-center px-3"
      >
        <h2 class="schedule-title">Ida: Domingo y Feriados</h2>
        <div class="container">
          <div class="row">
            <!-- Publicidad Izquierda Superior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-right"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarDom.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>

            <!-- Formulario de B煤squeda -->
            <div class="col-12 col-md-4">
              <div class="card rounded h-100">
                <div class="card-body">
                  <h5 class="card-title">Selecciona los detalles</h5>
                  <div
                    id="error-message"
                    class="alert alert-danger d-none"
                    role="alert"
                  ></div>
                  <form id="horarios-form">
                    <div class="mb-3">
                      <label for="estacion" class="form-label">Estaci贸n</label>
                      <select
                        id="estacion"
                        class="form-select"
                        required
                        aria-describedby="estacionHelp"
                      >
                        <option value="">Selecciona una estaci贸n</option>
                        <!-- Opciones cargadas por JS -->
                      </select>
                      <div id="estacionHelp" class="form-text">
                        Selecciona la estaci贸n de la que deseas consultar los
                        horarios
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="hora" class="form-label">Hora</label>
                      <input
                        type="time"
                        id="hora"
                        class="form-control"
                        required
                        aria-describedby="horaHelp"
                      />
                      <div id="horaHelp" class="form-text">
                        Ingresa la hora para consultar los pr贸ximos trenes
                      </div>
                    </div>
                    <button
                      type="submit"
                      class="btn bg-consultar w-100"
                      id="submit-btn"
                    >
                      Ver horarios
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <!-- Publicidad Derecha Superior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-left"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarDom.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>

            <!-- Publicidad Izquierda Inferior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-right"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarDom.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>

            <!-- Resultados de la B煤squeda -->
            <div class="col-12 col-md-4">
              <div class="card rounded h-100">
                <div class="card-body resultados-card">
                  <h5 class="card-title">Horarios Disponibles</h5>
                  <div
                    id="resultados"
                    class="overflow-auto"
                    style="max-height: 400px"
                  >
                    <p class="text-muted text-center" id="responseHelp">
                      Selecciona una estaci贸n y hora para ver los horarios
                      disponibles
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Publicidad Derecha Inferior -->
            <div class="col-12 col-md-4">
              <div
                class="card rounded h-100"
                data-aos="fade-left"
                data-aos-duration="3000"
                data-aos-once="false"
              >
                <img
                  src="../assets/images/consultarDom.png"
                  class="img-fluid h-100 object-fit-cover"
                  alt="Espacio Publicitario Disponible"
                  loading="lazy"
                />
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <!-- AOS JS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="../js/script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("horarios-form");
        const estacionSelect = document.getElementById("estacion");
        const horaInput = document.getElementById("hora");
        const submitBtn = document.getElementById("submit-btn");
        const resultadosDiv = document.getElementById("resultados");
        const errorDiv = document.getElementById("error-message");
        let horariosData = null;
        let currentLang = localStorage.getItem("selectedLanguage") || "es";
        let lastResultados = []; // Guardar los 煤ltimos resultados

        // Traducciones
        const translations = {
          es: {
            viewSchedules: "Ver horarios",
            consulting: "Consultando...",
            noSchedules:
              "No se encontraron horarios disponibles para la hora seleccionada.",
            selectValid:
              "Por favor, selecciona una estaci贸n y una hora v谩lidas.",
            errorLoading:
              "Error al cargar los horarios. Por favor, intente nuevamente.",
            errorProcessing:
              "Error al procesar los horarios. Por favor, intente nuevamente.",
            train: "Tren",
            departureTime: "Hora de salida",
          },
          en: {
            viewSchedules: "View schedules",
            consulting: "Consulting...",
            noSchedules: "No schedules available for the selected time.",
            selectValid: "Please select a valid station and time.",
            errorLoading: "Error loading schedules. Please try again.",
            errorProcessing: "Error processing schedules. Please try again.",
            train: "Train",
            departureTime: "Departure time",
          },
        };

        // Funci贸n para obtener texto traducido
        const t = (key) => translations[currentLang][key] || key;

        // Funci贸n para renderizar resultados
        const renderResultados = (resultados) => {
          resultadosDiv.innerHTML = "";
          if (resultados.length > 0) {
            resultados.forEach((horario) => {
              const div = document.createElement("div");
              div.className = "card mb-2";
              div.innerHTML = `
                <div class="card-body py-2">
                  <h5 class="card-subtitle mb-1">${t("train")} ${
                horario.num_tren
              }</h5>
                  <p class="card-text m-0">${t("departureTime")}: ${
                horario.hora_estacion
              }</p>
                </div>
              `;
              resultadosDiv.appendChild(div);
            });
          } else {
            resultadosDiv.innerHTML = `<div class="alert alert-info" role="alert">${t(
              "noSchedules"
            )}</div>`;
          }
        };

        // Establecer texto inicial del bot贸n
        submitBtn.textContent = t("viewSchedules");

        // Cargar horarios desde JSON
        fetch("../assets/JSON/horarios/horarios_domingo.json")
          .then((response) => {
            if (!response.ok) throw new Error(t("errorLoading"));
            return response.json();
          })
          .then((data) => {
            horariosData = data;
            data.estaciones.forEach((estacion, index) => {
              const option = document.createElement("option");
              option.value = index;
              option.textContent = estacion;
              estacionSelect.appendChild(option);
            });
          })
          .catch((error) => {
            errorDiv.textContent = t("errorLoading");
            errorDiv.classList.remove("d-none");
            console.error("Error fetching horarios:", error);
          });

        // Manejar formulario
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const selectedEstacionIdx = parseInt(estacionSelect.value);
          const selectedTime = horaInput.value;

          if (!horariosData || isNaN(selectedEstacionIdx) || !selectedTime) {
            errorDiv.textContent = t("selectValid");
            errorDiv.classList.remove("d-none");
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = t("consulting");
          errorDiv.classList.add("d-none");
          resultadosDiv.innerHTML =
            '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';

          setTimeout(() => {
            try {
              const [hours, minutes] = selectedTime.split(":").map(Number);
              const selectedMinutes = hours * 60 + minutes;

              lastResultados = horariosData.trenes
                .map((tren) => {
                  const horaEstacion = tren.horarios[selectedEstacionIdx];
                  if (!horaEstacion) return null;
                  const [h, m] = horaEstacion.split(":").map(Number);
                  const trenMinutes = h * 60 + m;
                  return trenMinutes >= selectedMinutes
                    ? { num_tren: tren.numero, hora_estacion: horaEstacion }
                    : null;
                })
                .filter((tren) => tren !== null)
                .sort((a, b) => {
                  const [ha, ma] = a.hora_estacion.split(":").map(Number);
                  const [hb, mb] = b.hora_estacion.split(":").map(Number);
                  return ha * 60 + ma - (hb * 60 + mb);
                })
                .slice(0, 5);

              renderResultados(lastResultados);
            } catch (error) {
              errorDiv.textContent = t("errorProcessing");
              errorDiv.classList.remove("d-none");
              console.error("Error procesando horarios:", error);
              resultadosDiv.innerHTML = "";
            } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = t("viewSchedules");
            }
          }, 500); // Retraso simulado
        });

        // Sincronizar con el cambio de idioma desde script.js
        document.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            currentLang = e.target.getAttribute("data-lang");
            console.log(
              "Cambio de idioma en Domingos y Feriados a:",
              currentLang
            );
            submitBtn.textContent = t("viewSchedules");
            if (lastResultados.length > 0) {
              renderResultados(lastResultados); // Re-renderizar resultados
            }
          });
        });
      });
    </script>
  </body>
</html>
